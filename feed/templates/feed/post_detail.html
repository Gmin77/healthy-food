{% extends 'base.html' %}

{% block content %}
<style>
  .custom-card {
    max-width: 600px; 
    margin: auto; 
  }
  .carousel-item .feed-image {
    object-fit: contain;
    width: 100%;
    height: 500px;
  }
  .carousel-item {
    transition: transform 1s ease, opacity 0.5s ease; 
  }
  .no-underline {
    text-decoration: none; 
  }
  .comment-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  .comment-actions {
    display: flex;
    gap: 10px;
  }
  .comment-actions button {
    background-color: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 14px;
  }
  .carousel-control-next-icon,
  .carousel-control-prev-icon {
    filter: invert(1);
  }
</style>
<div class="container mt-5">
    <div class="card custom-card">
      {% if post.feed_images.all %}
        <div id="carouselExampleControls" class="carousel slide" data-bs-interval="false">
          <div class="carousel-inner">
            {% for image in post.feed_images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ image.image.url }}" class="d-block w-100 feed-image" alt="...">
              </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
          </button>
        </div>
      {% endif %}
        

      <div class="card-body">
        <!-- 아래 코드에서 post.user.id 를 post.user.pk 로 변경 -->
        <h2><a href="{% url 'feed:view_user' pk=post.user.pk %}">{{ post.user.username }}</a></h2>
        <h2>{{ post.title }}</h2>
        <p class="mt-3">{{ post.body_text }}</p>
        
        <!-- 좋아요 버튼 수정 -->
        <a href="#" class="no-underline like-button" data-post="{{ post.id }}">
          {% if user in post.likes.all %}
            <span class="likes-count">❤️</span>
          {% else %}
            <span class="likes-count">🤍</span>
          {% endif %}
        </a>
        : <span class="likes-count">{{ post.likes.count }}</span>

        {% if post.content_type == 'review' and post.product %}
          <hr>
          <h5>제품 리뷰</h5>
          <p>제품명: {{ post.product.name }}</p>
          <p>판매자: {{ post.seller.username }}</p>
        {% endif %}
        
        <!-- 게시글에 대한 수정 및 삭제 버튼 추가 -->
        {% if request.user == post.user or request.user.is_staff %}
        <div class="edit-delete-buttons">
          <a href="{% url 'feed:post_edit' post.id %}" class="btn btn-primary">수정</a>
          <form action="{% url 'feed:post_delete' post.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">삭제</button>
          </form>
        </div>
        {% endif %}
      </div>
      <div class="card-footer text-muted">
        <p> {{ post.created_at|date:"Y-m-d H:i" }} </p>
      </div>

      <div class="card-footer">
        <h5>댓글</h5>
        {% for comment in post.comment_set.all %}
        <div class="comment-container">
          <div class="comment-header">
            <h6>{{ comment.user.username }}</h6>
            <div class="comment-actions">
              <p>{{ comment.created_at }}</p>
              {% if request.user == comment.user or request.user.is_staff %}
              <form action="{% url 'feed:comments_delete' comment.pk %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit">삭제</button>
              </form>
              {% endif %}
            </div>
          </div>
          <p>{{ comment.comment_text }}</p>
        </div>
        {% empty %}
        <p>댓글이 없습니다.</p>
        {% endfor %}
        
        <form action="{% url 'feed:comments_create' post.id %}" method="post">
          {% csrf_token %}
          {{ commentform }}
          <button type="submit" class="btn btn-primary">작성</button>
        </form>
      </div>
    </div>
</div>
<script>
// Django에서 제공하는 CSRF 토큰 가져오기
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

document.addEventListener("DOMContentLoaded", function(){
  const likeButtons = document.querySelectorAll('.like-button');
  
  likeButtons.forEach(button => {
    button.addEventListener('click', function(e){
      e.preventDefault();
      const postId = this.dataset.post; 
      console.log(csrftoken);

      fetch(`{%url "feed:like-content" post.id%}`, {
        method: 'POST',
        
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          'postId': postId,
        })
      })
      .then(response => response.json())
      .then(data => {
        const likeButton = this;
        const likesCountElement = likeButton.querySelector('.likes-count');
        likesCountElement.innerText = data.is_liked ? '❤️' : '🤍';
        likeButton.nextElementSibling.innerText = data.likes_count;
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    });
  });
});
</script>
{% endblock %}
